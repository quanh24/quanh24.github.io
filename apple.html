<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Fruit Box</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            background: #fffaf5;
            color: #333;
        }

        #game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        button {
            background: linear-gradient(#ffcc70, #ffaa00);
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: bold;
            margin: 4px;
            cursor: pointer;
            box-shadow: 1px 2px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }

        button:hover {
            transform: scale(1.05);
        }

        #mode-buttons {
            margin-bottom: 10px;
        }

        #board-container {
            display: flex;
            justify-content: center;
        }

        #board {
            border: 3px solid #ffaa00;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .cell {
            width: 36px;
            height: 36px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #eee;
            font-size: 18px;
            font-weight: bold;
            background-color: #fffdf4;
            transition: background 0.2s;
        }

        .selected {
            background-color: #fff0b3 !important;
        }

        #action-buttons {
            margin-top: 10px;
        }

        #info-panel {
            width: 240px;
            border-left: 2px solid #f0e0c0;
            padding-left: 20px;
        }

        .info-line {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .history-entry {
            padding: 6px;
            border-bottom: 1px dashed #ddd;
            font-size: 14px;
        }

        #game-over {
            color: crimson;
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div id="game-area">
        <!-- Ch·∫ø ƒë·ªô ch∆°i -->
        <div id="mode-buttons">
            <button onclick="startCountdownMode()">üïõ ƒê·∫øm Ng∆∞·ª£c</button>
            <button onclick="startTimedMode()">‚è± T√≠nh Gi·ªù</button>
        </div>

        <!-- Th√¥ng tin -->
        <div class="info-line">‚≠ê ƒêi·ªÉm: <span id="score">0</span></div>
        <div class="info-line">‚è± Th·ªùi gian: <span id="timer">0</span> gi√¢y</div>
        <div class="info-line">üîÅ ƒê√£ ƒë·∫£o: <span id="shuffle-count">0</span> l·∫ßn</div>

        <!-- B·∫£ng -->
        <div id="board-container">
            <table id="board"></table>
        </div>

        <!-- N√∫t ch·ª©c nƒÉng -->
        <div id="action-buttons">
            <button onclick="resetGame()">üîÑ Reset</button>
            <button onclick="undo()">‚Ü©Ô∏è Undo</button>
            <button onclick="useHint()" title="C·ªông th√™m 10 gi√¢y">üí° G·ª£i √Ω</button>
        </div>

        <!-- K·∫øt th√∫c -->
        <div id="game-over">‚õî H·∫øt th·ªùi gian, tr√≤ ch∆°i k·∫øt th√∫c!</div>
    </div>

    <div id="info-panel">
        <h3>üéÆ L·ªãch s·ª≠</h3>
        <div id="history"></div>
    </div>

    <!-- √Çm thanh -->
    <audio id="clickSound" src="click_embed.mp3" preload="auto"></audio>

    <script>
        const ROWS = 10, COLS = 17;
        let grid = [], score = 0, start = null, undoStack = [];
        let board = document.getElementById('board');
        let scoreEl = document.getElementById('score');
        let timerEl = document.getElementById('timer');
        let shuffleEl = document.getElementById('shuffle-count');
        let gameOverEl = document.getElementById('game-over');
        let historyEl = document.getElementById('history');
        let clickSound = document.getElementById('clickSound');
        let mode = "countdown", timer = null, time = 150, timedSeconds = 0, shuffleCount = 0;

        function generateGrid() {
            grid = Array.from({ length: ROWS }, () =>
                Array.from({ length: COLS }, () => 1 + Math.floor(Math.random() * 9))
            );
        }

        function renderBoard() {
            board.innerHTML = '';
            for (let i = 0; i < ROWS; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < COLS; j++) {
                    const td = document.createElement('td');
                    td.className = 'cell';
                    td.dataset.r = i;
                    td.dataset.c = j;
                    td.innerText = grid[i][j] === 0 ? '' : grid[i][j];
                    tr.appendChild(td);
                }
                board.appendChild(tr);
            }
        }

        function resetGame() {
            if (score > 0) addToHistory();
            generateGrid();
            renderBoard();
            score = 0;
            scoreEl.innerText = score;
            shuffleCount = 0;
            shuffleEl.innerText = shuffleCount;
            undoStack = [];
            gameOverEl.style.display = 'none';
            board.style.pointerEvents = 'auto';
            clearInterval(timer);

            if (mode === 'countdown') {
                time = 150;
                timerEl.innerText = time;
                timer = setInterval(() => {
                    time--;
                    timerEl.innerText = time;
                    if (time <= 0) {
                        clearInterval(timer);
                        endGame();
                    }
                }, 1000);
            } else {
                timedSeconds = 0;
                timerEl.innerText = timedSeconds;
                timer = setInterval(() => {
                    timedSeconds++;
                    timerEl.innerText = timedSeconds;
                    if (!hasValidMove()) shuffleBoard();
                    if (isBoardCleared()) {
                        clearInterval(timer);
                        gameOverEl.innerText = `üéâ Ho√†n th√†nh sau ${timedSeconds} gi√¢y!`;
                        gameOverEl.style.display = 'block';
                        board.style.pointerEvents = 'none';
                        addToHistory();
                    }
                }, 1000);
            }
        }

        function endGame() {
            board.style.pointerEvents = 'none';
            gameOverEl.style.display = 'block';
            addToHistory();
        }

        function addToHistory() {
            const entry = document.createElement('div');
            entry.className = 'history-entry';
            const now = new Date();
            entry.innerHTML = `
        <span>üïì ${now.toLocaleTimeString()}</span>
        <span>‚≠ê ƒêi·ªÉm: ${score}</span>
        <span>‚è± ${mode === "timed" ? `Ho√†n th√†nh: ${timedSeconds}s` : `C√≤n l·∫°i: ${time}s`}</span>
      `;
            historyEl.prepend(entry);
        }

        function isBoardCleared() {
            return grid.flat().every(v => v === 0);
        }

        function hasValidMove() {
            for (let r0 = 0; r0 < ROWS; r0++)
                for (let c0 = 0; c0 < COLS; c0++)
                    for (let r1 = r0; r1 < ROWS; r1++)
                        for (let c1 = c0; c1 < COLS; c1++) {
                            let sum = 0;
                            for (let i = r0; i <= r1; i++)
                                for (let j = c0; j <= c1; j++)
                                    sum += grid[i][j];
                            if (sum === 10) return true;
                        }
            return false;
        }

        function shuffleBoard() {
            let attempts = 0;
            const MAX_ATTEMPTS = 100;

            while (attempts < MAX_ATTEMPTS) {
                // Thay ƒë·ªïi gi√° tr·ªã ng·∫´u nhi√™n cho t·∫•t c·∫£ √¥ c√≤n l·∫°i
                for (let i = 0; i < ROWS; i++) {
                    for (let j = 0; j < COLS; j++) {
                        if (grid[i][j] !== 0) {
                            grid[i][j] = 1 + Math.floor(Math.random() * 9);
                        }
                    }
                }

                // Ki·ªÉm tra n·∫øu c√≥ n∆∞·ªõc ƒëi h·ª£p l·ªá th√¨ d·ª´ng
                if (hasValidMove()) break;

                attempts++;
            }

            shuffleCount++;
            shuffleEl.innerText = shuffleCount;
            renderBoard();
        }

        function useHint() {
            outer: for (let r0 = 0; r0 < ROWS; r0++)
                for (let c0 = 0; c0 < COLS; c0++)
                    for (let r1 = r0; r1 < ROWS; r1++)
                        for (let c1 = c0; c1 < COLS; c1++) {
                            let sum = 0;
                            for (let i = r0; i <= r1; i++)
                                for (let j = c0; j <= c1; j++)
                                    sum += grid[i][j];
                            if (sum === 10) {
                                for (let i = r0; i <= r1; i++)
                                    for (let j = c0; j <= c1; j++)
                                        board.rows[i].cells[j].classList.add('selected');
                                if (mode === 'timed') timedSeconds += 10;
                                timerEl.innerText = timedSeconds;
                                break outer;
                            }
                        }
        }

        function undo() {
            if (undoStack.length === 0) return;
            const last = undoStack.pop();
            grid = last.grid;
            score = last.score;
            scoreEl.innerText = score;
            renderBoard();
        }

        function startCountdownMode() {
            mode = "countdown";
            resetGame();
        }

        function startTimedMode() {
            mode = "timed";
            resetGame();
        }

        board.addEventListener('mousedown', e => {
            if (e.target.classList.contains('cell')) {
                start = { r: +e.target.dataset.r, c: +e.target.dataset.c };
                clearSelection();
            }
        });

        board.addEventListener('mouseup', e => {
            if (!start || !e.target.classList.contains('cell')) return;
            const end = { r: +e.target.dataset.r, c: +e.target.dataset.c };
            const r0 = Math.min(start.r, end.r), r1 = Math.max(start.r, end.r);
            const c0 = Math.min(start.c, end.c), c1 = Math.max(start.c, end.c);
            let sum = 0, cells = [];

            for (let i = r0; i <= r1; i++)
                for (let j = c0; j <= c1; j++) {
                    sum += grid[i][j];
                    cells.push(board.rows[i].cells[j]);
                }

            if (sum === 10) {
                undoStack.push({ grid: grid.map(row => [...row]), score });
                for (let i = r0; i <= r1; i++)
                    for (let j = c0; j <= c1; j++)
                        grid[i][j] = 0;
                score += cells.length;
                scoreEl.innerText = score;
                renderBoard();
                clickSound.play();
            }

            clearSelection();
            start = null;
        });

        board.addEventListener('mousemove', e => {
            if (!start || !e.target.classList.contains('cell')) return;
            clearSelection();
            const cr = +e.target.dataset.r, cc = +e.target.dataset.c;
            const r0 = Math.min(start.r, cr), r1 = Math.max(start.r, cr);
            const c0 = Math.min(start.c, cc), c1 = Math.max(start.c, cc);
            for (let i = r0; i <= r1; i++)
                for (let j = c0; j <= c1; j++)
                    board.rows[i].cells[j].classList.add('selected');
        });

        function clearSelection() {
            document.querySelectorAll('.cell.selected').forEach(td =>
                td.classList.remove('selected')
            );
        }

        startCountdownMode(); // Kh·ªüi ƒë·ªông m·∫∑c ƒë·ªãnh
    </script>
</body>

</html>